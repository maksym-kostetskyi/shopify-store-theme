{% comment %}
  Product page with main image, thumbnail gallery, and product info
  Features customizable Swiper gallery for thumbnails
{% endcomment %}

<div class="product-page" 
     data-section-id="{{ section.id }}"
     data-slides-desktop="{{ section.settings.slides_per_view_desktop | default: 4 }}"
     data-slides-tablet="{{ section.settings.slides_per_view_tablet | default: 3 }}"
     data-slides-mobile="{{ section.settings.slides_per_view_mobile | default: 2 }}"
     data-enable-pagination="{{ section.settings.enable_pagination | default: true }}"
     data-enable-navigation="{{ section.settings.enable_navigation | default: true }}"
     data-space-between="{{ section.settings.space_between_slides | default: 10 }}">
  
  <div class="product-container">
    <!-- Product Images Section -->
    <div class="product-images-section">
      <!-- Debug info -->
      {% comment %}
      Debug: Product ID: {{ product.id }}
      Debug: Product Images Count: {{ product.images.size }}
      Debug: Has Featured Image: {{ product.featured_image != blank }}
      {% endcomment %}
      
      {% if product and product.images.size > 0 %}
        <!-- Main Image -->
        <div class="product-main-image">
          <img 
            id="main-product-image"
            src="{{ product.featured_image | image_url: width: 800 }}" 
            alt="{{ product.featured_image.alt | escape }}"
            width="800"
            height="800"
            class="main-image"
            loading="eager"
          >
          {% if section.settings.enable_navigation and product.images.size > 1 %}
            <div class="main-image-prev" onclick="window.productGallery.prevImage()" data-direction="prev"></div>
            <div class="main-image-next" onclick="window.productGallery.nextImage()" data-direction="next"></div>
          {% endif %}
        </div>
        
        <!-- Thumbnail Gallery -->
        {% if product.images.size > 1 %}
          <div class="product-thumbnails">
            <div class="swiper thumbnail-swiper">
              <div class="swiper-wrapper">
                {% for image in product.images %}
                  <div class="swiper-slide">
                    <div class="thumbnail-wrapper {% if forloop.first %}active{% endif %}">
                      <img 
                        src="{{ image | image_url: width: 150 }}" 
                        alt="{{ image.alt | escape }}"
                        class="thumbnail-image"
                        data-main-image="{{ image | image_url: width: 800 }}"
                        data-index="{{ forloop.index0 }}"
                        loading="lazy"
                        width="150"
                        height="150"
                      >
                    </div>
                  </div>
                {% endfor %}
              </div>
              
              {% if section.settings.enable_pagination %}
                <div class="swiper-pagination thumbnail-pagination"></div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% else %}
        <!-- Placeholder for no images -->
        <div class="product-image-placeholder">
          <div class="placeholder-wrapper">
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            <p class="placeholder-text">
              {% if product %}
                No product images available
              {% else %}
                Please select a product to view
              {% endif %}
            </p>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Product Info Section -->
    <div class="product-info-section">
      <div class="product-info">
        <h1 class="product-title">{{ product.title }}</h1>
        
        <div class="product-price">
          <span class="current-price">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
            <span class="compare-price">{{ product.compare_at_price | money }}</span>
            <span class="savings">Save {{ product.compare_at_price | minus: product.price | money }}</span>
          {% endif %}
        </div>
        
        {% if product.description != blank %}
          <div class="product-description">
            {{ product.description }}
          </div>
        {% endif %}
        
        <div class="product-form">
          {% form 'product', product %}
            {% assign current_variant = product.selected_or_first_available_variant %}

            {% if product.variants.size > 1 %}
              <div class="variant-selector">
                <label for="variant-select">Options:</label>
                <select name="id" id="variant-select" class="variant-select">
                  {% for variant in product.variants %}
                    <option
                      value="{{ variant.id }}"
                      {% if variant == current_variant %}selected="selected"{% endif %}
                      {% unless variant.available %}disabled{% endunless %}
                    >
                      {{ variant.title }} - {{ variant.price | money }}
                      {% unless variant.available %} (Sold Out){% endunless %}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% else %}
              <input type="hidden" name="id" value="{{ current_variant.id }}">
            {% endif %}

            {% if current_variant.available %}
              <div class="quantity-cart-row">
                <div class="quantity-selector">
                  <label for="quantity">Quantity:</label>
                  <input type="number" name="quantity" id="quantity" min="1" value="1" class="quantity-input">
                </div>
                <button type="submit" class="add-to-cart-btn">
                  Add to Cart
                </button>
              </div>
            {% else %}
              <button type="submit" class="add-to-cart-btn" disabled>
                Sold Out
              </button>
            {% endif %}
            
          {% endform %}
        </div>
      </div>
    </div>
  </div>
</div>

{% stylesheet %}
  /* Product Page Layout */
  .product-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .product-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: start;
  }
  
  /* Product Images Section */
  .product-images-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .product-main-image {
    width: 100%;
    max-width: 450px;
    height: auto;
    max-height: 450px;
    overflow: hidden;
    border-radius: 12px;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .main-image {
    width: 100%;
    max-width: 450px;
    height: auto;
    max-height: 450px;
    object-fit: contain;
    cursor: zoom-in;
    border-radius: 8px;
  }
  
  /* Main Image Navigation Arrows */
  .main-image-prev,
  .main-image-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    color: #333;
    font-size: 16px;
    font-weight: bold;
    z-index: 10;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    opacity: 0;
    pointer-events: none;
  }
  
  .product-main-image:hover .main-image-prev,
  .product-main-image:hover .main-image-next {
    opacity: 1 !important;
    pointer-events: auto !important;
  }
  
  /* Temporary: Make buttons always visible for debugging */
  .main-image-prev,
  .main-image-next {
    opacity: 1 !important;
    pointer-events: auto !important;
  }
  
  .product-main-image:hover .main-image-prev[style*="opacity: 0.3"],
  .product-main-image:hover .main-image-next[style*="opacity: 0.3"] {
    opacity: 0.3 !important;
    pointer-events: none !important;
  }
  
  .main-image-prev:hover,
  .main-image-next:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .main-image-prev {
    left: 15px;
  }
  
  .main-image-next {
    right: 15px;
  }
  
  .main-image-prev::after {
    content: '←';
  }
  
  .main-image-next::after {
    content: '→';
  }
  
  /* Disabled state for navigation buttons */
  .main-image-prev[style*="opacity: 0.3"],
  .main-image-next[style*="opacity: 0.3"] {
    cursor: not-allowed;
    background: rgba(200, 200, 200, 0.9);
    color: #999;
  }
  
  .main-image-prev[style*="opacity: 0.3"]:hover,
  .main-image-next[style*="opacity: 0.3"]:hover {
    background: rgba(200, 200, 200, 0.9);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  /* Thumbnail Gallery */
  .product-thumbnails {
    width: 100%;
    max-width: 450px;
    position: relative;
    overflow: hidden;
  }
  
  .thumbnail-swiper {
    width: 100%;
    padding: 0;
    overflow: hidden;
  }
  
  .thumbnail-swiper .swiper-wrapper {
    display: flex;
    flex-direction: row;
  }
  
  .thumbnail-swiper .swiper-slide {
    width: 120px !important;
    flex-shrink: 0;
  }
  
  .thumbnail-wrapper {
    width: 120px;
    height: 120px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f5f5f5;
    flex-shrink: 0;
  }
  
  .thumbnail-wrapper:hover {
    border-color: #007aff;
    transform: scale(1.05);
  }
  
  .thumbnail-wrapper.active {
    border-color: #007aff;
    box-shadow: 0 0 0 1px #007aff;
  }
  
  .thumbnail-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 6px;
  }
  
  /* Hide thumbnail navigation - we use main image navigation instead */
  .thumbnail-prev,
  .thumbnail-next {
    display: none;
  }
  
  /* Thumbnail Pagination */
  .thumbnail-pagination {
    margin-top: 1rem;
    text-align: center;
  }
  
  .thumbnail-pagination .swiper-pagination-bullet {
    width: 8px;
    height: 8px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 50%;
    margin: 0 3px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .thumbnail-pagination .swiper-pagination-bullet-active {
    background: #007aff;
    transform: scale(1.2);
  }
  
  /* Product Info Section */
  .product-info-section {
    padding: 1rem 0;
    max-width: 400px;
  }
  
  .product-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: #333;
    line-height: 1.3;
  }
  
  .product-price {
    margin-bottom: 15px;
  }
  
  .current-price {
    font-size: 1.75rem;
    font-weight: 700;
    color: #007aff;
  }
  
  .compare-price {
    font-size: 1.25rem;
    color: #999;
    text-decoration: line-through;
    margin-left: 0.5rem;
  }
  
  .savings {
    display: inline-block;
    background: #e74c3c;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-left: 0.5rem;
  }
  
  .product-description {
    font-size: 1rem;
    line-height: 1.6;
    color: #666;
    margin-bottom: 15px;
  }
  
  /* Product Form */
  .product-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .variant-selector {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .quantity-selector {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .quantity-cart-row {
    display: flex;
    gap: 1rem;
    align-items: end;
  }
  
  .quantity-cart-row .quantity-selector {
    flex: 1;
  }
  
  .quantity-cart-row .add-to-cart-btn {
    flex-shrink: 0;
  }
  
  .variant-selector label,
  .quantity-selector label {
    font-weight: 600;
    color: #333;
  }
  
  .variant-select,
  .quantity-input {
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  
  .variant-select:focus,
  .quantity-input:focus {
    outline: none;
    border-color: #007aff;
  }
  
  .quantity-input {
    width: 80px;
  }
  
  .add-to-cart-btn {
    background: #007aff;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 6px;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .add-to-cart-btn:hover:not(:disabled) {
    background: #0056cc;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
  }
  
  .add-to-cart-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  /* Placeholder */
  .product-image-placeholder {
    width: 100%;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    border-radius: 12px;
  }
  
  .placeholder-wrapper {
    text-align: center;
    padding: 2rem;
  }
  
  .placeholder-svg {
    width: 120px;
    height: 120px;
    opacity: 0.5;
  }
  
  .placeholder-text {
    margin-top: 1rem;
    color: #666;
    font-size: 0.9rem;
  }
  
  /* Responsive Design */
  @media screen and (max-width: 768px) {
    .product-page {
      padding: 1rem;
    }
    
    .product-container {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    
    .product-title {
      font-size: 1.5rem;
    }
    
    .current-price {
      font-size: 1.5rem;
    }
    
    .thumbnail-swiper {
      padding: 0 30px;
    }
    
    .thumbnail-prev,
    .thumbnail-next {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }
  }
  
  @media screen and (max-width: 480px) {
    .product-page {
      padding: 0.5rem;
    }
    
    .thumbnail-swiper {
      padding: 0 25px;
    }
  }
{% endstylesheet %}

{% javascript %}
  // Global gallery object to avoid sandbox issues
  window.productGallery = {
    currentIndex: 0,
    thumbnails: [],
    mainImage: null,
    thumbnailSwiper: null,
    
    init: function() {
      console.log('Initializing product gallery (global approach)');
      
      const productPage = document.querySelector('.product-page');
      if (!productPage) {
        console.log('No product page found');
        return;
      }
      
      this.mainImage = document.querySelector('#main-product-image');
      this.thumbnails = document.querySelectorAll('.thumbnail-image');
      
      console.log('Found', this.thumbnails.length, 'thumbnails');
      
      // Initialize Swiper
      this.initSwiper(productPage);
      
      // Setup thumbnail clicks
      this.setupThumbnails();
      
      // Update initial state
      this.updateNavigationState();
    },
    
    initSwiper: function(productPage) {
      if (!window.Swiper) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js';
        script.onload = () => this.createSwiper(productPage);
        document.head.appendChild(script);
      } else {
        this.createSwiper(productPage);
      }
    },
    
    createSwiper: function(productPage) {
      const thumbnailContainer = document.querySelector('.thumbnail-swiper');
      if (!thumbnailContainer) return;
      
      const slidesDesktop = Math.max(2, parseInt(productPage.dataset.slidesDesktop) || 4);
      const slidesTablet = Math.max(2, parseInt(productPage.dataset.slidesTablet) || 3);
      const slidesMobile = Math.max(2, parseInt(productPage.dataset.slidesMobile) || 2);
      const enablePagination = productPage.dataset.enablePagination === 'true';
      const spaceBetween = parseInt(productPage.dataset.spaceBetween) || 10;

      this.thumbnailSwiper = new Swiper(thumbnailContainer, {
        slidesPerView: slidesMobile,
        spaceBetween: spaceBetween,
        loop: false,
        grabCursor: true,
        breakpoints: {
          768: { slidesPerView: slidesTablet },
          1024: { slidesPerView: slidesDesktop }
        },
        pagination: enablePagination ? {
          el: '.thumbnail-pagination',
          clickable: true,
          dynamicBullets: true,
        } : false,
      });
    },
    
    setupThumbnails: function() {
      const self = this;
      this.thumbnails.forEach(function(thumbnail, index) {
        thumbnail.onclick = function() {
          self.switchToImage(index);
        };
      });
    },
    
    prevImage: function() {
      console.log('Prev clicked, current:', this.currentIndex);
      if (this.currentIndex > 0) {
        this.currentIndex--;
        this.switchToImage(this.currentIndex);
        this.ensureThumbnailVisible(this.currentIndex);
        this.updateNavigationState();
      }
    },
    
    nextImage: function() {
      console.log('Next clicked, current:', this.currentIndex);
      if (this.currentIndex < this.thumbnails.length - 1) {
        this.currentIndex++;
        this.switchToImage(this.currentIndex);
        this.ensureThumbnailVisible(this.currentIndex);
        this.updateNavigationState();
      }
    },
    
    switchToImage: function(index) {
      console.log('Switching to image', index);
      this.currentIndex = index;
      
      const thumbnail = this.thumbnails[index];
      if (!thumbnail || !this.mainImage) return;
      
      const newImageSrc = thumbnail.dataset.mainImage;
      const newImageAlt = thumbnail.alt;
      
      this.mainImage.src = newImageSrc;
      this.mainImage.alt = newImageAlt;
      
      this.updateActiveThumbnail(index);
      this.ensureThumbnailVisible(index);
      this.updateNavigationState();
    },
    
    updateActiveThumbnail: function(activeIndex) {
      const thumbnailWrappers = document.querySelectorAll('.thumbnail-wrapper');
      thumbnailWrappers.forEach(function(wrapper, index) {
        if (index === activeIndex) {
          wrapper.classList.add('active');
        } else {
          wrapper.classList.remove('active');
        }
      });
    },
    
    updateNavigationState: function() {
      const prevBtn = document.querySelector('.main-image-prev');
      const nextBtn = document.querySelector('.main-image-next');
      
      if (!prevBtn || !nextBtn) return;
      
      if (this.currentIndex <= 0) {
        prevBtn.style.opacity = '0.3';
        prevBtn.style.pointerEvents = 'none';
      } else {
        prevBtn.style.opacity = '1';
        prevBtn.style.pointerEvents = 'auto';
      }
      
      if (this.currentIndex >= this.thumbnails.length - 1) {
        nextBtn.style.opacity = '0.3';
        nextBtn.style.pointerEvents = 'none';
      } else {
        nextBtn.style.opacity = '1';
        nextBtn.style.pointerEvents = 'auto';
      }
    },
    
    ensureThumbnailVisible: function(index) {
      if (!this.thumbnailSwiper) return;
      
      const totalSlides = this.thumbnails.length;
      const slideWidth = 120 + 10; // thumbnail width + gap
      const containerWidth = this.thumbnailSwiper.el.clientWidth;
      
      console.log('DEBUG - thumbnail', index, 'containerWidth:', containerWidth, 'slideWidth:', slideWidth);
      
      // For the last thumbnail, calculate exact position to make it fully visible
      if (index === totalSlides - 1) {
        // Calculate how far we need to translate to show the last slide fully
        const totalWidth = totalSlides * slideWidth;
        const translateX = -(totalWidth - containerWidth);
        
        console.log('Last thumbnail - totalWidth:', totalWidth, 'translateX:', translateX);
        
        // Use setTranslate to directly position the swiper
        this.thumbnailSwiper.setTranslate(translateX);
        this.thumbnailSwiper.updateProgress();
        this.thumbnailSwiper.updateSlidesClasses();
      } else {
        // For other thumbnails, use normal slideTo
        const targetSlide = Math.max(0, index - 1);
        console.log('Regular thumbnail - using slideTo:', targetSlide);
        this.thumbnailSwiper.slideTo(targetSlide, 300);
      }
    }
  };

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      window.productGallery.init();
    });
  } else {
    window.productGallery.init();
  }
{% endjavascript %}


{% schema %}
{
  "name": "Product Gallery",
  "settings": [
    {
      "type": "header",
      "content": "Thumbnail Gallery Settings"
    },
    {
      "type": "range",
      "id": "slides_per_view_desktop",
      "label": "Thumbnails per row (Desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "info": "Number of thumbnail images shown at once on desktop"
    },
    {
      "type": "range",
      "id": "slides_per_view_tablet",
      "label": "Thumbnails per row (Tablet)",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3,
      "info": "Number of thumbnail images shown at once on tablet"
    },
    {
      "type": "range",
      "id": "slides_per_view_mobile",
      "label": "Thumbnails per row (Mobile)",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 2,
      "info": "Number of thumbnail images shown at once on mobile"
    },
    {
      "type": "header",
      "content": "Navigation Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_pagination",
      "label": "Show pagination dots",
      "default": true,
      "info": "Display dots below thumbnails for navigation"
    },
    {
      "type": "checkbox",
      "id": "enable_navigation",
      "label": "Show navigation arrows",
      "default": true,
      "info": "Display left/right arrows for thumbnail navigation"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "space_between_slides",
      "label": "Space between thumbnails",
      "min": 5,
      "max": 30,
      "step": 5,
      "unit": "px",
      "default": 10,
      "info": "Gap between thumbnail images"
    }
  ],
  "presets": [
    {
      "name": "Product Gallery",
      "category": "Product"
    }
  ]
}
{% endschema %}
